---
title: kafka-definition-guide-6
date: 2021-01-28 13:22:16
tags:
- kafka
---
### 신뢰성 있는 시스템에서 프로듀서 사용하기
- 시나리오 1
    - replica 3, unclean leader election, producer ack 1
    - 프로듀서가 메세지를 전송하면 리더에 쓰게 되지만 동기화 리플리카에는 아직 쓰지 않은 상황
    - 리더는 프로듀서에게 '메세지를 성공적으로 썼음' 응답 후 데이터가 다른 리플리카에 복제되기 전에 곧바로 중단
    - 이 경우 in-sync replica로 간주된 하나의 replica 가 리더가 됨
    - 메세지는 새로 리더가 된 리플리카에 쓰지 않았으므로 유실
- 시나리오 2
    - replica 3, unclean leader election, producer ack all
    - 쓰려고 하는데 해당 파티션의 리더가 방금 중단되어 새로운 리더 선출 중
    - 카프카는 '사용할 수 있는 리더가 없음' 에러 응답
    - 쓰기가 성공적으로 될 때까지 프로듀서가 해당 에러를 제대로 처리하지 못해 재시도 하지 않는 다면 메세지 유실
    
- 신뢰성 요구 사항에 맞도록 acks 구성 매개변수를 올바르게 설정해야 한다.
- 구성 매개변수와 코드 모두에서 에러 처리를 올바르게 해야 한다.

### 확인 응답 전송
- acks = 0 : 프로듀서가 네트어ㅜ크로 메세지를 전송했다면 카프카가 성공적으로 쓴 것으로 간주
    - 전송하는 개체가 직렬화 될 수 없거나, 네트워크 카드 장애가 생기면 프로듀서가 에러를 받음
    - 그러나 메세지를 쓸 파티ㅕㅅㄴ이 오프라인이거나 관련 카프카 클러스터의 처리가 늦어지는 경우는 에러를 받지 않음. 이에 리더 선출이 예상되는 상황의 메세지는 유실될 가능성 존재
    
- acks = 1 : 리더가 메시지를 수신하고 파티션 데이터 파일에 쓴 후 확인 응답 또는 에러를 전송한다.
    - 리더 선출 중일 경우 프로듀서는 LeaderNotAvailable Exception 예외 발생
    - 프로듀서가 이 예외를 올바르게 처리한다면 해당 메세지를 다시 전송하여 새로운 리더가 수신하게 됨
