---
title: designing-data-intensive-application-6
date: 2020-09-14 15:24:22
tags:
- partitioning
---

### partitioning
- Sharding
    - 데이터 파티셔닝을 원히는 주된 이유는 확장성이다
    
### 키-값데이터파티셔닝
- 파티셔닝이 고르게 이뤄지지 않이- 다른 파티션보다 데이터가 많거 나 질의를 많이 받는 파티션이 있 다면 쏠렸다(skewed)고 말한다.
- 불균형하게 부하가 높은 파티션을 핫스팟이라고 힌다.

### 키 범위 기준 파티셔닝
- 파티셔닝하는 방법 중 하나는 종이 백과사전처럼(그림 6-2) 각 파티션에 연속된 범위(어떤 최솟값 에서 최뱃값까지)의 키를 할당하는 것이다.
![](/images/data-intensive/chapter_6/key_range_based_partitioning.png) 
- 장점
    - 키를 정렬된 순서로 저장할 수 있다.
- 단점
    - 키 범위 기준파티셔닝은 특정한 접근패턴이 핫스핏을 유발
    
### 키의 해시값 기준 파티셔닝
- 파티셔닝용 해시 함수는 암호적으로 강력할 필요는 없다.
    - 카산드라, 몽고DB : MD5
    - 볼드모트 : 파울러 놀 보 (Fowler-Noll-Vo)
- 장점 
    - 키를 파티션 사이에 균일하게 분산시키는데 좋다
- 단점
    - 범위 질의를 효율적으로 실행할 수 있는 능력이 부족하다.
- 카산드라는 테이블을 선언할 때 여러 칼럼을 포함하는 복합 기본키를 지정해 SS테이블에서 데이터를 정렬하는 연쇄된 색인으로 사용한다.

### 쏠린 작업부하와 핫스팟 완화
- 항상 동일한 키를 읽고 쓰는 극단적인 상황에서는 모든 요청이 동일한 파티션으로 쏠리게 된다.

### 파티셔닝과 보조 색인
- 지금까지 설명한 파티셔닝 방식은 키-값 데이터 모델에 의존한다.
- 보조 색인은 관계형 데이터베이스의 핵심 요소이며 문서 데이터베이스에서도 흔하다.

### 문서 기준 보조 색인 파티셔닝
- 각 항목에는 문서 ID라고 불리는 고유 ID가 존재한다.
![](/images/data-intensive/chapter_6/document_based_sub_index_partitioning.png) 

- 지역 색인(Local Index)이라고도 한다.
- 문서ID에 뭔가 특별한 작업을 하지 않는다면 동일 파티션에 저장되리라는 보장이 없기 때문에 모든 파티션으로 질의를 보내 얻은 결과를 모두 보아야 한다.
- 스캐터/개더(scatter/gather)라고 한다.

### 용어 기준 보조 색인 파티셔닝
- term-partitioning : 용어(문서에 등장하는 모든 단) 기준 파티셔닝
![](/images/data-intensive/chapter_6/term_based_sub_index_partitioning.png) 

### 파티션 재균형화
- 질의 처리랑이 증가해서 늘어난 부하를 처리하기 위해 CPU를 더 추가하고 싶다.
- 데이터셋 크기가 증가해서 데이터셋 저장에 시용할 디스크와 램을 추가하고 싶다. 
- 장비에 장애가 발생해서 그 장비가 담당하던 역할을 다른 서버가 넘겨받아야 한다.
- 재균형화 : 클러스터에서 한 노드가 담당하던 부하를 다른 노드로 옮기는 과정을 재균형화(rebalancing)이라고 한다.
    - 재균형화 후, 부하(데이터저장소, 읽기 쓰기 요청)가 클러스터 내에 있는 노드들 사이에 균등하게 분배돼야 한다.
    - 재균형화 도중에도 데이터베이스는 읽기 쓰기 요청을 받아들여야 한다
    - 재균형화가 빨리 실행되고 네트워크와 디스크 I/0 부하를 최소화할 수 있도록 노드들 사이에 데이터가 필요 이상으로 옮겨 져서는 안된다

### 재균형화 전략
- 쓰면 안되는 방법 : 해시값에 모드 N 연산을 실행
    - 재균형화 비용이 지나지체 커진다.
- 파티션 개수 고정

